<head>
<!-- 画面設計図　スライド10~34 -->
    <title>プラン詳細画面（詳細情報）</title>

    {% load static %}
    <link rel="stylesheet" href="{% static 'plans/plan_detail.css' %}">
</head>

<body>
    <div class="page-title">{{ object.plan_name }}</div>
    <form method="POST" class="form-container">
        {% csrf_token %}

        <div class="tab-menu">
            <button type="button" class="tab-btn" data-target=".tab-memo">メモ</button>

            {% for row in schedule_rows %} 
            <button type="button" class="tab-btn" data-target=".tab-schedule-{{ forloop.counter }}" {% if row.day %}data-day-id="{{ row.day.id }}"{% endif %}>
                {{ row.date|date:"n/j" }}
            </button>
            {% endfor %}
            
            <button type="button" class="tab-btn" data-target=".tab-detail">詳細情報</button>
            <button type="button" class="tab-btn" data-target=".tab-map">map</button>
            <button type="button" class="tab-btn" data-target=".tab-cost">費用</button>
        </div>    
        
        <!-- 画面設計図　スライド10 プラン詳細画面（詳細情報） -->
        <div class="tab-content tab-detail">
            <p>旅行タイトル</p>
            <p>{{ object.plan_name }}</P>

            <p>出発日</p>
            <p>{{ object.start_date }}</P>

            <p>帰宅日</p>
            <p>{{ object.end_date }}</P>

            <p>予定費用</p>

            <p>実際費用</p>

            <p>メンバーとの共有</p>
            <a class="member-add">メンバーを追加する</a>
            <a href="{% url 'plans:share_revoke' %}" class="revoke-btn">URLを失効</a>

            <a href="{% url 'plans:plan_edit' %}" class="edit-btn">編集</a>
        </div>
        
        <!-- 画面設計図　スライド16 プラン詳細画面（メモ）-->
        <div class="tab-content tab-memo">

            <div class="memo-paper">
                <p class="memo-text">
                    初日の集合時間　〇〇駅に8時
                </p>

                <button type="button" class="memo-edit-btn">メモ編集</button>
            </div>

        </div>

        <!-- 画面設計図　スライド18 プラン詳細画面（1日詳細）-->
        {% for row in schedule_rows %}
            <div class="tab-content tab-schedule-{{ forloop.counter }}"{% if row.day %}data-day-id="{{ row.day.id }}"{% endif %}>
                <p>{{ row.date|date:"n/j" }}の予定</p>

                <div class="schedule-memo">
                    <p class="memo-text">
                        {% if row.day and row.day.memo %}
                            {{ row.day.memo }}
                        {% else %}
                            ・メモはありません。
                        {% endif %}
                    </p>

                    <a href="{% url 'plans:schedule_memo' %}" class="memo-edit-btn">
                        メモ編集
                    </a>

                </div>
            
                {% if row.day %}
                    {% for schedule in row.schedules %}

                        {% if schedule.destination %}
                            <a href="{% url 'destinations:destination_detail' schedule.destination.id %}?day_schedule_id={{ row.day.id }}"
                                class="schedule-row" data-schedule-id="{{ schedule.id }}" data-day-id="{{ row.day.id }}" data-order="{{ schedule.order }}">
                        {% else %}
                            <a href="{% url 'plans:schedule_edit' schedule.id %}" class="schedule-row"
                                data-schedule-id="{{ schedule.id }}" data-day-id="{{ row.day.id }}" data-order="{{ schedule.order }}">
                        {% endif %}    

                            <span class="time">
                                {{ schedule.arrival_time }}〜{{ schedule.departure_time }}
                            </span>
                        
                            <span class="destination">
                                {% if schedule.destination %}
                                    {{ schedule.destination.name }}
                                {% else %}
                                    目的地未設定
                                {% endif %}
                            </span>
                        </a> 

                    {% empty %}
                        <p class="no-schedule">予定はありません。</p>
                    {% endfor %}
                {% endif %}

                {% if row.day and row.day.id %}
                    <a href="{% url 'destinations:destination_search' %}?day_schedule_id={{ row.day.id }}" class="destination-btn">目的地検索</a>
                {% endif %}
            </div>
        {% endfor %}


        <!-- 画面設計図　スライド29 プラン詳細画面（MAP）-->
        <div class="tab-content tab-map">

            <div class="map-area">
                <div class="map-placeholder">
                    地図（ここにピン表示）
                </div>
            </div>   

        </div>    
         
        <!-- 画面設計図　スライド32 プラン詳細画面（費用）-->
        <div class="tab-content tab-cost">
            
            <!-- 合計金額 -->
            <div class="cost-summary">
                <p class="cost-summary-amount">￥{{ total_cost }}</p>
            </div>
            
            <!-- 費用一覧 -->
            <div class="cost-list">
                {% for category in categories %}
                    <div class="cost-category-block">


                        <!-- カテゴリー名 + 合計 -->
                        <div class="cost-category-header">
                            <span class="category-name">{{ category.name }}</span>
                            <span class="category-total">
                                ¥{{ category.total|default:0 }}
                            </span>
                        </div>

                        <!-- 中身 -->
                        <div class="cost-items">
                            {% for cost in category.items.all %}
                                <div class="cost-item">
                                    <p class="cost-name">{{ cost.name }}</p>
                                    <p class="cost-amount">¥{{ cost.amount }}</p>
                                </div>
                            {% empty %}
                                <p>費用はまだありません。</p>
                            {% endfor %}
                        </div>
                    </div>
                {% empty %}
                    <p>費用はまだありません。</p>
                {% endfor %}
            </div>    

            <a href="{% url 'plans:plan_cost_edit' object.id %}" class="cost-add-btn">＋</a>

        </div>

    </form>

    <!-- スライド13　共有URL表示（モーダル）-->
    <div class="share-modal">
        <div class="share-modal-content">
            <button type="button" class="share-modal-close">×</button>

            <p class="share-title">共有URL</p>

            <p class="share-url">
                https://example.com/plan/share?token=xxxx
            </p>
        </div>  
    </div>

    <script>
        document.querySelectorAll('.tab-btn').forEach((btn) =>{
            btn.addEventListener('click', () => {

                // タブの切り替え
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // タブの中身　切り替え
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); 
                const target = btn.dataset.target;
                document.querySelector(target).classList.add('active');
            });
        });

        document.addEventListener("DOMContentLoaded", () => {
            const params = new URLSearchParams(window.location.search);
            const dayId = params.get("day_schedule_id");

            // いったん全部リセット
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            // ?day があればそれを表示
            if (dayId) {
                const targetContent = document.querySelector(
                    `.tab-content[data-day-id="${dayId}"]`
                );
                const targetBtn = document.querySelector(
                    `.tab-btn[data-day-id="${dayId}"]`
                );

                if (targetContent && targetBtn) {
                    targetContent.classList.add('active');
                    targetBtn.classList.add('active');
                    return;
                }
            }

            // なければ「最初のスケジュール」を表示
            const firstContent = document.querySelector('.tab-content.tab-schedule-1');
            const firstBtn = document.querySelector('.tab-btn[data-target=".tab-schedule-1"]');

            if (firstContent && firstBtn) {
                firstContent.classList.add('active');
                firstBtn.classList.add('active');
            }
        });


        // スライド13　共有URL表示（モーダル）
        const shareModal = document.querySelector('.share-modal');
        const openShareBtn = document.querySelector('.member-add');
        const closeShareBtn = document.querySelector('.share-modal-close');

        if (openShareBtn && shareModal && closeShareBtn){
            openShareBtn.addEventListener('click', () => {
                shareModal.classList.add('active');
            });

            closeShareBtn.addEventListener('click', () => {
                shareModal.classList.remove('active');
            });
        }

    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

    <script>// 目的地の順番並び替えを有効化
        document.querySelectorAll('.tab-content').forEach((tab) => {
            new Sortable(tab, {
                animation: 150,
                draggable: '.schedule-row',
                handle: '.schedule-row',

                onEnd: function () {
                    const rows = tab.querySelectorAll('.schedule-row');
                    if (!rows.length) return;

                    const formData = new FormData();
                    rows.forEach(row => {
                        const id = row.dataset.scheduleId;
                        if (!id) return;   // ← schedule-idを持たない行は無視をするって意味
                        formData.append('order[]', id);
                    });

                    // day_id は、行が持っている day_schedule_id を利用
                    formData.append("day_id", rows[0].dataset.dayId);

                    fetch("{% url 'plans:schedule_reorder' %}", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                        body: formData,
                    });
                },
            });
        });
    </script>

</body>    