<head>
<!-- ç”»é¢è¨­è¨ˆå›³ã€€ã‚¹ãƒ©ã‚¤ãƒ‰10~34 -->
    <title>ãƒ—ãƒ©ãƒ³è©³ç´°ç”»é¢ï¼ˆè©³ç´°æƒ…å ±ï¼‰</title>

    {% load static %}
    <link rel="stylesheet" href="{% static 'plans/plan_detail.css' %}">
</head>

<body>
    <div class="page-title">{{ object.plan_name }}</div>
    <form method="POST" class="form-container">
        {% csrf_token %}

        <div class="tab-menu">
            <button type="button" class="tab-btn" data-target=".tab-memo">ãƒ¡ãƒ¢</button>

            {% for row in schedule_rows %} 
            <button type="button" class="tab-btn" data-target=".tab-schedule-{{ forloop.counter }}" {% if row.day %}data-day-id="{{ row.day.id }}"{% endif %}>
                {{ row.date|date:"n/j" }}
            </button>
            {% endfor %}
            
            <button type="button" class="tab-btn" data-target=".tab-detail">è©³ç´°æƒ…å ±</button>
            <button type="button" class="tab-btn" data-target=".tab-map">map</button>
            <button type="button" class="tab-btn" data-target=".tab-cost">è²»ç”¨</button>
        </div>    
        
        <!-- ç”»é¢è¨­è¨ˆå›³ã€€ã‚¹ãƒ©ã‚¤ãƒ‰10 ãƒ—ãƒ©ãƒ³è©³ç´°ç”»é¢ï¼ˆè©³ç´°æƒ…å ±ï¼‰ -->
        <div class="tab-content tab-detail">
            <p>æ—…è¡Œã‚¿ã‚¤ãƒˆãƒ«</p>
            <p>{{ object.plan_name }}</P>

            <p>å‡ºç™ºæ—¥</p>
            <p>{{ object.start_date }}</P>

            <p>å¸°å®…æ—¥</p>
            <p>{{ object.end_date }}</P>

            <p>äºˆå®šè²»ç”¨</p>

            <p>å®Ÿéš›è²»ç”¨</p>

            <p>ãƒ¡ãƒ³ãƒãƒ¼ã¨ã®å…±æœ‰</p>
            <a class="member-add">ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã™ã‚‹</a>
            <a href="{% url 'plans:share_revoke' %}" class="revoke-btn">URLã‚’å¤±åŠ¹</a>

            <a href="{% url 'plans:plan_edit' %}" class="edit-btn">ç·¨é›†</a>
        </div>
        
        <!-- ç”»é¢è¨­è¨ˆå›³ã€€ã‚¹ãƒ©ã‚¤ãƒ‰16 ãƒ—ãƒ©ãƒ³è©³ç´°ç”»é¢ï¼ˆãƒ¡ãƒ¢ï¼‰-->
        <div class="tab-content tab-memo">

            <div class="memo-paper">
                {% if request.GET.memo_edit %}
                    <textarea name="plan_memo" class="memo-textarea">
                        {{ object.memo }}
                    </textarea>

                    <button type="submit" class="memo-complete-btn">å®Œäº†</button>
                
                {% else %}
                    <p class="memo-text">
                        {% if object.memo %}
                            {{ object.memo }}
                        {% else %}
                            ãƒ»ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                        {% endif %}
                    </p>

                    <a href="?memo_edit=1" class="memo-edit-btn">
                        ãƒ¡ãƒ¢ç·¨é›†
                    </a>
                {% endif %}
            </div>

        </div>

        <!-- ç”»é¢è¨­è¨ˆå›³ã€€ã‚¹ãƒ©ã‚¤ãƒ‰18 ãƒ—ãƒ©ãƒ³è©³ç´°ç”»é¢ï¼ˆ1æ—¥è©³ç´°ï¼‰-->
        {% for row in schedule_rows %}
            <div class="tab-content tab-schedule-{{ forloop.counter }}"{% if row.day %}data-day-id="{{ row.day.id }}"{% endif %}>
                <p>{{ row.date|date:"n/j" }}ã®äºˆå®š</p>

                <div class="schedule-memo">
                    <p class="memo-text">
                        {% if row.day and row.day.memo %}
                            {{ row.day.memo }}
                        {% else %}
                            ãƒ»ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                        {% endif %}
                    </p>

                    <a href="{% url 'plans:schedule_memo' row.day.id  %}" class="memo-edit-btn">
                        ãƒ¡ãƒ¢ç·¨é›†
                    </a>

                </div>
            
                {% if row.day %}
                    {% for schedule in row.schedules %}

                        {% if schedule.destination %}
                            <a href="{% url 'destinations:destination_detail' schedule.destination.id %}?day_schedule_id={{ row.day.id }}"
                                class="schedule-row" data-schedule-id="{{ schedule.id }}" data-day-id="{{ row.day.id }}" data-order="{{ schedule.order }}">
                        {% else %}
                            <a href="{% url 'plans:schedule_edit' schedule.id %}" class="schedule-row"
                                data-schedule-id="{{ schedule.id }}" data-day-id="{{ row.day.id }}" data-order="{{ schedule.order }}">
                        {% endif %}    

                            <span class="time">
                                {{ schedule.arrival_time }}ã€œ{{ schedule.departure_time }}
                            </span>
                        
                            <span class="destination">
                                {% if schedule.destination %}
                                    {{ schedule.destination.name }}
                                {% else %}
                                    ç›®çš„åœ°æœªè¨­å®š
                                {% endif %}
                            </span>
                        </a> 

                    {% empty %}
                        <p class="no-schedule">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    {% endfor %}
                {% endif %}

                {% if row.day and row.day.id %}
                    <a href="{% url 'destinations:destination_search' %}?day_schedule_id={{ row.day.id }}" class="destination-btn">ç›®çš„åœ°æ¤œç´¢</a>
                {% endif %}
            </div>
        {% endfor %}


        <!-- ç”»é¢è¨­è¨ˆå›³ã€€ã‚¹ãƒ©ã‚¤ãƒ‰29 ãƒ—ãƒ©ãƒ³è©³ç´°ç”»é¢ï¼ˆMAPï¼‰-->
        <div class="tab-content tab-map">

            <div class="map-area">
                <div class="map-placeholder">
                    åœ°å›³ï¼ˆã“ã“ã«ãƒ”ãƒ³è¡¨ç¤ºï¼‰
                </div>
            </div>   

        </div>    
         
        <!-- ç”»é¢è¨­è¨ˆå›³ã€€ã‚¹ãƒ©ã‚¤ãƒ‰32 ãƒ—ãƒ©ãƒ³è©³ç´°ç”»é¢ï¼ˆè²»ç”¨ï¼‰-->
        <div class="tab-content tab-cost">
            
            <!-- åˆè¨ˆé‡‘é¡ -->
            <div class="cost-summary">
                <p class="cost-summary-amount">ï¿¥{{ total_cost }}</p>
            </div>
            
            <!-- è²»ç”¨ä¸€è¦§ -->
            <div class="cost-list">
                {% if total_cost == 0 %}
                    <p>è²»ç”¨ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                {% endif %}

                {% for category in categories %}
                    <div class="cost-category-block">

                        <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼å + åˆè¨ˆ -->
                        <div class="cost-category-header">
                            <span class="category-name">{{ category.name }}</span>

                            <span class="category-right">
                                <span class="category-total">Â¥{{ category.total|default:0 }}</span>
                                <span class="category-toggle-icon">â–½</span>
                            </span>
                        </div>

                        <!-- ä¸­èº« -->
                        <div class="cost-items hidden">
                            {% for cost in category.items.all %}
                                <div class="cost-item">
                                    <p class="cost-name">{{ cost.name }}</p>
                                    <p class="cost-amount">Â¥{{ cost.amount }}</p>
                                    <a class="cost-edit-icon"
                                        href="{% url 'plans:plan_cost_edit_item' object.id cost.id %}">
                                        âœï¸
                                    </a>
                                    <a href="{% url 'plans:cost_delete' object.id cost.id %}" class="cost-delete-icon">
                                        ğŸ—‘
                                    </a>
                                </div>    
                            {% endfor %}    
                                
                                <a href="{% url 'plans:cost_category_edit' object.id category.id %}">
                                    ã‚«ãƒ†ã‚´ãƒªãƒ¼ç·¨é›†
                                </a>

                                <p>è²»ç”¨ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                        </div>
                    </div>    
                {% endfor %}
            </div>    

            <a href="{% url 'plans:plan_cost_edit' object.id %}" class="cost-add-btn">ï¼‹</a>

        </div>

    </form>

    <!-- ã‚¹ãƒ©ã‚¤ãƒ‰13ã€€å…±æœ‰URLè¡¨ç¤ºï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰-->
    <div class="share-modal">
        <div class="share-modal-content">
            <button type="button" class="share-modal-close">Ã—</button>

            <p class="share-title">å…±æœ‰URL</p>

            <p class="share-url">
                https://example.com/plan/share?token=xxxx
            </p>
        </div>  
    </div>

    <script>
        document.querySelectorAll('.tab-btn').forEach((btn) =>{
            btn.addEventListener('click', () => {

                // ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆ
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // ã‚¿ãƒ–ã®ä¸­èº«ã€€åˆ‡ã‚Šæ›¿ãˆ
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); 
                const target = btn.dataset.target;
                document.querySelector(target).classList.add('active');
            });
        });

        document.addEventListener("DOMContentLoaded", () => {
            const params = new URLSearchParams(window.location.search);
            const dayId = params.get("day_schedule_id");
            const memoTab = params.get("memo_tab");

            if (memoTab) {
                const memoContent = document.querySelector(".tab-memo");
                const memoBtn = document.querySelector('.tab-btn[data-target=".tab-memo"]');

                if (memoContent && memoBtn) {
                    memoContent.classList.add("active");
                    memoBtn.classList.add("active");
                    return;
                }
            }

            // ã„ã£ãŸã‚“å…¨éƒ¨ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            // ?day ãŒã‚ã‚Œã°ãã‚Œã‚’è¡¨ç¤º
            if (dayId) {
                const targetContent = document.querySelector(
                    `.tab-content[data-day-id="${dayId}"]`
                );
                const targetBtn = document.querySelector(
                    `.tab-btn[data-day-id="${dayId}"]`
                );

                if (targetContent && targetBtn) {
                    targetContent.classList.add('active');
                    targetBtn.classList.add('active');
                    return;
                }
            }

            // ãªã‘ã‚Œã°ã€Œæœ€åˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€ã‚’è¡¨ç¤º
            const firstContent = document.querySelector('.tab-content.tab-schedule-1');
            const firstBtn = document.querySelector('.tab-btn[data-target=".tab-schedule-1"]');

            if (firstContent && firstBtn) {
                firstContent.classList.add('active');
                firstBtn.classList.add('active');
            }
        });


        // ã‚¹ãƒ©ã‚¤ãƒ‰13ã€€å…±æœ‰URLè¡¨ç¤ºï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
        const shareModal = document.querySelector('.share-modal');
        const openShareBtn = document.querySelector('.member-add');
        const closeShareBtn = document.querySelector('.share-modal-close');

        if (openShareBtn && shareModal && closeShareBtn){
            openShareBtn.addEventListener('click', () => {
                shareModal.classList.add('active');
            });

            closeShareBtn.addEventListener('click', () => {
                shareModal.classList.remove('active');
            });
        }

    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

    <script>// ç›®çš„åœ°ã®é †ç•ªä¸¦ã³æ›¿ãˆã‚’æœ‰åŠ¹åŒ–
        document.querySelectorAll('.tab-content').forEach((tab) => {
            new Sortable(tab, {
                animation: 150,
                draggable: '.schedule-row',
                handle: '.schedule-row',

                onEnd: function () {
                    const rows = tab.querySelectorAll('.schedule-row');
                    if (!rows.length) return;

                    const formData = new FormData();
                    rows.forEach(row => {
                        const id = row.dataset.scheduleId;
                        if (!id) return;   // â† schedule-idã‚’æŒãŸãªã„è¡Œã¯ç„¡è¦–ã‚’ã™ã‚‹ã£ã¦æ„å‘³
                        formData.append('order[]', id);
                    });

                    // day_id ã¯ã€è¡ŒãŒæŒã£ã¦ã„ã‚‹ day_schedule_id ã‚’åˆ©ç”¨
                    formData.append("day_id", rows[0].dataset.dayId);

                    fetch("{% url 'plans:schedule_reorder' %}", {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                        body: formData,
                    });
                },
            });
        });
    </script>

    <script> // è²»ç”¨ã‚¿ãƒ–ã®â–½é–‹é–‰
    document.addEventListener("DOMContentLoaded", () => {    
        document.querySelectorAll(".cost-category-header").forEach((header) => {
            header.addEventListener("click", () => {
                const block = header.closest(".cost-category-block");
                const items = block.querySelector(".cost-items");
                const icon = header.querySelector(".category-toggle-icon");

                if (!items) return;

                items.classList.toggle("hidden");
  
                const isHidden = items.classList.contains("hidden");
                if (icon) icon.textContent = isHidden ? "â–½" : "â–²";
            });
        });
    });
    </script>

</body>